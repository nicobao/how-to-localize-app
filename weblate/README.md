# How to configure Weblate?

## Installing Weblate

### Docker install (doc not up to date with all the details)

See official Weblate instructions of use the following.

On the server, run

```
git clone https://github.com/WeblateOrg/docker-compose.git weblate-docker
cd weblate-docker
```

Then replace `docker-compose.override.yml` with:
```
version: '3'
services:
  weblate:
    environment:
      WEBLATE_EMAIL_HOST: smtp.myapplication.com
      WEBLATE_EMAIL_HOST_USER: myapplication
      WEBLATE_EMAIL_HOST_PASSWORD: <password>
      WEBLATE_SERVER_EMAIL: admin@myapplication.com
      WEBLATE_DEFAULT_FROM_EMAIL: admin@myapplication.com
      WEBLATE_SITE_DOMAIN: localization.myapplication.com
      WEBLATE_ADMIN_EMAIL: admin@myapplication.com
      WEBLATE_ADMIN_PASSWORD: <password>
      WEBLATE_ENABLE_HTTPS: 1
      WEBLATE_REGISTRATION_OPEN: 1
      WEBLATE_REGISTRATION_ALLOW_BACKENDS: github
      WEBLATE_SOCIAL_AUTH_GITHUB_KEY: <key>
      WEBLATE_SOCIAL_AUTH_GITHUB_SECRET: <secret>
  https-portal:
    environment:
      DOMAINS: 'localization.myapplication.com -> http://weblate:8080'
```

Finally, run Weblate by executing:
```
docker compose -f docker-compose-https.yml -f docker-compose.override.yml up -d
```

### Manual install (up to date)

NOTE: you can also install Weblate with Docker: 

On the server:
- Create a weblate user (home in /opt/weblate)
- Follow [these instructions](https://docs.weblate.org/en/latest/admin/install/venv-debian.html) (ignore virtualenv configurations)
- Install `git-svn` package
- Add at least one ADMIN in `settings.py`
- Ensure to generate a SECRET_KEY with at least 50 chars for `settings.py`
- Add backup service ([https://localization.myapplication.com/manage/backup/](https://localization.myapplication.com/manage/backup/)) with Backup repository URL = `/var/local/weblate/backup` 

### Firewall issues

- You might need to open 80/443 for letsencrypt certificate renewal

## Configuring Weblate

### Make your GitHub account super-admin ("site admin")

- Connect with your GitHub account
- Logout
- Connect with the admin account (email/password is in the Weblate docker conf above)
- Click on the screwdiver icon on the right side of the top navbar
- Select the `Users` tab
- Click on your GitHub user
- Navigate to `Edit`
- Check the checkbox `Superuser status`

### Delete the auto-generated Django admin account

- In the same place as above, click on the Admin account
- Click on `Delete` and confirm

## Create the project

- Connect a super-admin user
- Navigate to `Dashboard`
- Click on the `+` icon on the right side of the top navbar
- Click on `Add new translation project`
- In `Project name`, choose `MyApplication`
- Leave `URL slug` be
- Put `https://app.myapplication.com` in Project website

## Modify the visibility of the project

By default, everything is public, thus modifyable by anyone having a GitHub account (everyone is Translator by default).

- Connect a super-admin user
- Click on the MyApplication project
- Go to `Manage -> Settings`
- Click on `Access`
- Select `Protected`

## Create the first component

This component will be the one that's configured to connect to the VCS.
One component = one file mask = one dev file like `common.json`.
The other components will be linked to this one. 
All the other components will be autogenerated except the glossary that has to be created manually.

Note: In practice, `common.json` is not used in the JS code. It's only here for weblate.

For this first component, take example with the existing `Common` component in the `MyApplication` project: https://localization.myapplication.com/settings/myapplication/common/ (Manage -> Settings)

Configure the component as follows:
- Connect a super-admin user
- Click on the project you just created
- Click on `Add new translation component`
- In `Component Name`, put `Common`
- Leave `URL slug` be
- Do not tick `Use as a glossary`
- Leave `Project` be
- Leave `Source language` be
- Choose `Git with force push` in `Version control system`
- Choose `git@github.com:MyApplication/MyApplication-localization.git` for `Source code repository`
- Choose `main` for `Repository branch`
- Click on `Continue`, choose `Specify configuration manually` and click on `Continue`. Everything will be prefilled until `Repository branch`.
- Choose `git@github.com:MyApplication/MyApplication-localization.git` for repository push URL
- Choose `main` OR `feat-weblate-myapplication-main` for push branch (up to you if you want to add another step of PR generation and validation)
- Choose `https://github.com/MyApplication/MyApplication-localization/blob/{{branch}}/{{filename}}#L{{line}}` for repository browser
- Choose `i18next JSON file v3` for file format
- Choose `myapplication/locales/*/common.json` for file mask
- Choose `myapplication/locales/en-US/common.json` for `Monolingual base language file`
- Leave `Edit base file` checked
- Leave `Adding new translation` to `Create new language file`
- Choose `myapplication/locales/dev/common.json` for `Intermediate language file`
- Leave `Template for new translations` empty
- Choose `Apache License 2.0` for Translation license
- Choose `BCP style using hyphen as a separator` for `Language code style`
- Leave language filter be
- Leave `Source language` be
- Leave `Use as a glossary` unchecked
- Click on `Save`

![](./images/weblate-01.png)

Then it should create the Component.
You still need to edit some config:
- Click on the `Common` component you just created
- Go to `Manage > Settings`
- Click on `Version control` tab and
	- Uncheck `Push on commit`
	- Choose `0` for `age of changes to commit`
	- Choose `Rebase` for `Merge style`
	- Leave `Lock on error` checked


Change the commit messages:
- Make them all compliant with conventional commits (add `fix:` in front of all of the fields for example)

Now you need to create add-ons:
- In the `Common` component, click on `Manage -> Add-ons`
- Then install:
	- `Customize JSON output`, to comply with existing prettier, use: 
		- `JSON indentation`: 4
		- `JSON indentation style`: Spaces
	- `Add missing languages`
	- `Cleanup translation files`
	- `Squash Git commits`. Select `Per author`.
	- `Component discovery`:
		- Choose `myapplication/locales/(?P<language>[^/.]*)/(?P<component>[^/]*)\.json` for `Regular expression to match translation files against`
		- Select `i18next JSON file v3`
		- `{{ component|title }}` in `Customize the component name`
		- `myapplication/locales/en-US/{{ component }}.json` in `Define the monolingual base filename`
		- Empty for `Define the base file for new translations`
		- `myapplication/locales/dev/{{ component }}.json` for `Intermediate language file`
		- Leave language filter be
		- Leave `Clone add-ons ...` selected and `Remove components for inexisting files` unchecked.
		- Save and confirm the selection. It's normal that they detect the `dev` language. It will not appear in any languages in Weblate anyway because `dev` is not a recognized language format in Weblate. And `dev` is still configured as the intermediate language, it's ok.
		- Note: if you have only `locales/dev/componentName.json` but not `locales/en-US/componentName.json` then the component `componentName` will not be picked up by the add-on (a bug). Devs need to create an empty JSON file `{}` in `locales/en-US/componentName.json`.


## Edit the auto-generated MyApplication glossary component

- In the `MyApplication` component, click on `Manage -> Settings`
- In the `Basic` tab:
    - Choose `Apache License 2.0` for Translation license
- In the `Version Control` tab:
    - Choose `Git with force push` for `Version control system`
    - Choose `weblate://myapplication/common` for `Source code repository`
    - Empty `Repository branch`
- In the `Files` tab:
    - Choose `i18next JSON file v3` for file format
    - Choose `shared/unpackaged/locales/*/glossary.json` for file mask
    - Leave language filter be
    - Leave `Source language` to English
    - Choose `shared/unpackaged/locales/en-US/glossary.json` for `Monolingual base language file`
    - Leave `Edit base file` checked
    - Choose `shared/unpackaged/locales/dev/glossary.json` for `Intermediate language file`
    - Leave `Template for new translations` empty
    - Leave `Adding new translation` to `Create new language file`
    - Choose `BCP style using hyphen as a separator` for `Language code style`

## Create the translations teams

By default, anyone that connect to the app is in the "Translate" team and can translate every language.

We can create two teams, for each language:
- Go to the project MyApplication
- Go to `Manage -> Users`
- Click on the `Teams` panel
- Create the `English translators` team:
	- Give the rights `Edit source`, `Add suggestion`, `Translate`, `Review strings`
	- Give the languages `English`, `Enlish (United States)`, `English (Developer)`
	- Click on `Add`
- Create the `Chinese translators` team:
	- Give the rights `Add suggestion`, `Translate`, `Review strings`
	- Give the languages `Chinese (Simplified)`
	- Click on `Add`

## How to give rights to a translator on the project?

- Go to the project MyApplication
- Go to `Manage -> Users`
- Click on the `Users` panel
- Type the users GitHub handle or email address and click `Add`
- Edit his/her/their teams, remove `Translate` and assign the translator to the `English translators` or `Chinese translators` team
⚠️ **WARNING**: You can not remove yourself!

## Check configuration is ok

```bash
weblate@localization:~$ weblate check --deploy
System check identified some issues:

WARNINGS:
?: (security.W018) You should not have DEBUG set to True in deployment.

INFOS:
?: (weblate.I021) Error collection is not set up, it is highly recommended for production use
	HINT: https://docs.weblate.org/en/weblate-4.14.1/admin/install.html#collecting-errors

System check identified 2 issues (1 silenced).
```

That's it! Enjoy!

## Configure systemd service

This will make Weblate automatically commit every minute (locally).

- `/etc/systemd/system/celery.service`
```
[Unit]
Description=Celery

[Service]
Type=forking
User=weblate
Group=weblate
WorkingDirectory=/opt/weblate
ExecStart=/usr/local/lib/python3.8/dist-packages/weblate/examples/celery start
ExecStop=/usr/local/lib/python3.8/dist-packages/weblate/examples/celery stop
Restart=always

[Install]
WantedBy=multi-user.target
```

- `/etc/systemd/system/weblate.service`:
```
[Unit]
Description=Weblate
After=celery.service
Requires=celery.service

[Service]
Type=simple
User=weblate
Group=weblate
WorkingDirectory=/opt/weblate
ExecStart=/usr/local/bin/weblate runserver
Restart=always

[Install]
WantedBy=multi-user.target
```

- `weblate-commit-pending.service`:
```
[Unit]
Description=Weblate Commit Pending Service
Wants=weblate-commit-pending.timer

[Service]
User=weblate
Group=weblate
Type=oneshot
ExecStart=/usr/local/bin/weblate commit_pending --all --age 0
ExecStartPost=/bin/bash -c '/usr/bin/find /opt/weblate/data/vcs/myapplication/common/myapplication/locales -type f|xargs -L1 chmod 644'

[Install]
WantedBy=multi-user.target
```

- `weblate-commit-pending.timer`:
```
[Unit]
Description=Weblate Commit Pending Timer
Requires=weblate-commit-pending.service

[Timer]
Unit=weblate-commit-pending.service
OnCalendar=*:*:0/10

[Install]
WantedBy=timers.target
```

## Configure backup

```bash
root@localization:~ via 🐍 v3.8.10 ❯ crontab -l
0 1 * * * pg_dump -d weblate > "/root/backup-postgres/$(date -I)-weblate.dump"
```

## GitHub configuration

- Create a new GitHub account that will be used by weblate.
- Associate to this account the SSH and GPG key that's generated by Weblate:
	- Click on `About Weblate`
	- Click on `Keys` and copy the SSH and GPG key and associate them to the account you just created.
- Give that user write access to the `MyApplication-localization` repo
- Add a GitHub webhook: https://docs.weblate.org/en/latest/admin/continuous.html#github-setup - use `https://localization.myapplication.com/hooks/github` for the payload URL. This will notify weblate instantly anytime someone pushes to the repo!

## Note

Weblate can send a PR via the GitHub API instead of pushing to a branch. It turns out when you activate the adds-on, it becomes buggy, so I'd avoid it and push to a branch, then trigger a PR via a GitHub Action OR simply push to `main`.

In general, renaming strings is bad. The sync between the JSON file and the Weblate DB doesn't work well.
Advice to devs: either delete one or add a new one. This is true for any localization management solutions, including Pontoon.

If you really need to, you can find a hacky rename script `renameComponent.sh` in the directory. Use it at your own risk.
